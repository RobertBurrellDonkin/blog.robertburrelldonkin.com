---
title: Cheatsheet – Apache Kafka – Consumers
slug: "/cheatsheets/kafka/consumer"
---


# Consumer Groups
 * Consumer maintain membership in consumer group and ownership of partitions by **heartbeats**
    * **heartbeats** sent to broker designated as **group coordinator** for that consumer group
    * **heartbeats** sent using background thread
    * too many missed **heartbeats** triggers rebalance
 * Rebalances
    * Type depends on partition assignment strategy
        * **Eager Rebalance**
            * unavailable for window
            * all consumers stop, leave, rejoin with new assignment
        * **Cooperative Rebalance** aka **incremental partitions**
            * iterations based on partition subsets
            * important
                * in large consumer groups
                * when some consumers may take time to complete processing
 * Consumer group leader
    * **first** consumer to join group
    * assigns partitions
 * Static group membership
    * ```group.instance.id``` makes consumer a static member
    * static members do not leave on shutdown
    * should a second member with the same ```group.instance.id``` try to join then error
    * ```session.timeout.ms``` should be set
        * high enough to avoid rebalances on restart but
        * low enough to avoid too large data gaps for assigned partitions

# Properties

## Required
 * ```bootstrap.servers```
  * comma-separated ```host:port``` list of brokers
  * at least one required
  * no requirement for all brokers
  * if all listed brokers are down, producer cannot make initial connection to cluster
 * ```key.desercializer```
 * ```value.deserializer```

## Important
 * ```group.id``` consumer group
    * almost all consumers will be part of a group to allow scaling out horizontally

### Throughput, Memory Use, Availability

 * ```fetch.min.bytes``` defaults to **1**
    * set higher
        * if consumers uses too much CPU when little data available
        * to reduce broker load for large numbers of consumers
 * ```fetch.max.wait.ms``` defaults to **500ms**
    * in conjunction with ```fetch.min.bytes```
    * to limit potential latancy set lower
 * ```fetch.max.bytes``` defaults to **50MB**
    * limits memory required on consumer
    * if first batch exceeds fetch size then limit will be ignored
 * ```max.poll.records``` max number
    * limits processing needed per poll
 * ```max.partition.fetch.bytes```
    * most often ```fetch.max.bytes``` more useful
 * ```session.timeout.ms``` defaults to **10s**
    * lower values trade faster recovery for more rebalances
 * ```heartbeat.interval.ms```
    * typically set to one-third of ```session.timeout.ms```


# Consumer Structure

## Topic Subscription

```consumer.subscribe(topics)```

 * One or more topics
 * Static or dynamic
 * Regex supported
    * When new topic matching regex is added then rebalance will be triggered
    * Performance overhead

## Pool loop

```consumer.pool(timeout)```

 * consumer must continue to poll or be considered dead
    * ```max.poll.interval.ms```
 * one consumer per thread

